{
    "title": "Webhook Trigger & Studienbescheinigung",
    "description": "Sendet Webhooks per Ajax und bietet ein Upload-Formular für Studienbescheinigungen mit Token-basiertem Löschen und automatischem Cleanup nach 7 Tagen.",
    "content": "# Webhook Trigger & Studienbescheinigung\n\n## Übersicht\n\nDas Webhook Trigger Modul bietet zwei Hauptfunktionen: (1) Das Senden von Webhook-Requests via Ajax für verschiedene Aktionen und (2) Ein Upload-Formular für Studienbescheinigungen mit automatischer Dateiverwaltung. Das Modul unterstützt sichere Token-basierte Dateilöschung und automatisches Cleanup alter Uploads.\n\n## Hauptfunktionen\n\n- Ajax-basierte Webhook-Trigger\n- Upload-System für Studienbescheinigungen\n- Token-basiertes Löschen ohne Login\n- Automatisches Cleanup nach 7 Tagen\n- Dateigröße-Validierung (max. 2MB)\n- Unterstützte Formate: PDF, JPG, PNG\n- Mitgliedsbescheinigung anfordern\n\n## Shortcodes\n\n### [webhook_ajax_trigger]\n\nErstellt einen Button, der einen Webhook per Ajax auslöst.\n\n**Parameter:**\n- `url` (erforderlich): Webhook-Ziel-URL\n- `method`: HTTP-Methode (Standard: POST)\n- `status_id`: ID des Elements für Statusausgabe\n- `success_msg`: Erfolgsmeldung\n- `error_msg`: Fehlermeldung\n\n**Beispiel:**\n```\n[webhook_ajax_trigger \n  url=\"https:\/\/api.example.com\/webhook\" \n  method=\"POST\"\n  status_id=\"status-output\"\n  success_msg=\"Erfolgreich gesendet!\"\n  error_msg=\"Fehler beim Senden\"]\n```\n\n**Ausgabe:**\n```html\n<button class=\"webhook-trigger-btn\">Mitgliedsbescheinigung anfordern<\/button>\n<div class=\"webhook-output\"><\/div>\n```\n\n### [webhook_status_output]\n\nErstellt ein Ausgabe-Element für Webhook-Status.\n\n**Parameter:**\n- `id` (erforderlich): Eindeutige ID für das Ausgabe-Element\n\n**Beispiel:**\n```\n[webhook_status_output id=\"mgb\"]\n```\n\n### [studierendenstatue_beantragen]\n\nErstellt ein Modal-Formular zum Upload von Studienbescheinigungen.\n\n**Parameter:**\n- `url` (erforderlich): API-Endpoint für Upload-Benachrichtigung\n\n**Beispiel:**\n```\n[studierendenstatue_beantragen url=\"https:\/\/api.example.com\/student-certificate\"]\n```\n\n**Funktionen:**\n- Modal-Dialog mit Upload-Formular\n- Jahr-Eingabe (Gültigkeitsjahr)\n- Datei-Upload (PDF, JPG, PNG, max. 2MB)\n- Automatische Übertragung an API\n- Token für späteres Löschen\n\n## Ajax-Aktionen\n\n### webhook_trigger\n\nSendet Webhook-Request mit Benutzerinformationen.\n\n**Payload:**\n```json\n{\n  \"zoho_id\": \"12345\",\n  \"user_id\": 42\n}\n```\n\n**Sicherheit:**\n- Nur für eingeloggte Benutzer\n- Nutzt WordPress wp_remote_request\n\n### student_certificate_upload\n\nVerarbeitet Upload von Studienbescheinigungen.\n\n**Upload-Flow:**\n1. Datei-Validierung (Typ, Größe)\n2. Datei auf Server speichern\n3. Token generieren\n4. Payload an Ziel-URL senden\n5. Token in DB speichern\n\n**Gesendete Daten:**\n```json\n{\n  \"user_id\": 42,\n  \"zoho_id\": \"12345\",\n  \"year\": \"2025\",\n  \"file_url\": \"https:\/\/example.com\/wp-content\/uploads\/xyz.pdf\",\n  \"delete_token\": \"abc123...\"\n}\n```\n\n## REST API Endpunkte\n\n### POST \/wp-json\/dgptm\/v1\/delete_file\n\nLöscht eine hochgeladene Datei anhand des Tokens.\n\n**Berechtigung:** Öffentlich (kein Login erforderlich)\n\n**Parameter:**\n- `token` (erforderlich): Lösch-Token\n\n**Beispiel:**\n```bash\ncurl -X POST https:\/\/example.com\/wp-json\/dgptm\/v1\/delete_file \\\n  -H \"Content-Type: application\/json\" \\\n  -d '{\"token\": \"abc123xyz...\"}'\n```\n\n**Antwort (Erfolg):**\n```json\n{\n  \"status\": \"success\",\n  \"message\": \"Datei erfolgreich gelöscht.\"\n}\n```\n\n**Antwort (Fehler):**\n```json\n{\n  \"status\": \"error\",\n  \"message\": \"Ungültiges oder abgelaufenes Token.\"\n}\n```\n\n## Einrichtung\n\n### 1. Webhook-Ziel konfigurieren\n\n```\n[webhook_ajax_trigger \n  url=\"https:\/\/ihre-api.com\/endpoint\"\n  success_msg=\"Anfrage erfolgreich!\"\n  error_msg=\"Fehler aufgetreten\"]\n```\n\n### 2. Studienbescheinigung-Upload einrichten\n\n```\n[studierendenstatue_beantragen url=\"https:\/\/ihre-api.com\/certificates\"]\n```\n\n### 3. API-Endpoint vorbereiten\n\nIhr API-Endpoint sollte folgende Daten empfangen:\n\n```json\n{\n  \"user_id\": 123,\n  \"zoho_id\": \"67890\",\n  \"year\": \"2025\",\n  \"file_url\": \"https:\/\/...\",\n  \"delete_token\": \"token123\"\n}\n```\n\n## Verwendung\n\n### Mitgliedsbescheinigung anfordern\n\n1. Benutzer klickt auf Button\n2. Ajax-Request wird gesendet mit:\n   - `zoho_id` (aus User Meta)\n   - `user_id` (aktueller Benutzer)\n3. Webhook-Ziel verarbeitet Request\n4. Erfolgs-\/Fehlermeldung wird angezeigt\n\n### Studienbescheinigung hochladen\n\n1. Benutzer klickt \"Studierendenstatus beantragen\"\n2. Modal öffnet sich\n3. Jahr eingeben (z.B. \"2025\")\n4. Datei auswählen (PDF\/JPG\/PNG, max. 2MB)\n5. \"Hochladen & Senden\" klicken\n6. Datei wird hochgeladen und an API gesendet\n7. Token wird generiert für späteres Löschen\n\n### Datei löschen (über API)\n\n```bash\ncurl -X POST https:\/\/ihre-site.com\/wp-json\/dgptm\/v1\/delete_file \\\n  -d \"token=abc123xyz\"\n```\n\n## Technische Details\n\n### Automatisches Cleanup\n\n**Hook:** `init`\n**Funktion:** `dgptm_cleanup_old_uploads()`\n**Intervall:** Bei jedem Seitenaufruf\n**Kriterium:** Dateien älter als 7 Tage\n\n**Prozess:**\n1. Alle gespeicherten Tokens abrufen\n2. Erstellungsdatum prüfen\n3. Wenn > 7 Tage: Datei löschen + Token entfernen\n\n### Datei-Verwaltung\n\n**Option:** `dgptm_files`\n**Struktur:**\n```php\n[\n  'token123' => [\n    'file_path' => '\/pfad\/zur\/datei.pdf',\n    'created_at' => 1234567890\n  ],\n  \/\/ ...\n]\n```\n\n### Validierung\n\n**Erlaubte MIME-Types:**\n- `application\/pdf`\n- `image\/jpeg`\n- `image\/jpg`\n- `image\/png`\n\n**Max. Dateigröße:** 2 MB (2.097.152 Bytes)\n\n### JavaScript-Dateien\n\n**webhook-ajax.js:**\n- Button-Click-Handler\n- Ajax-Request für Webhooks\n- Status-Ausgabe\n\n**student-certificate.js:**\n- Modal-Steuerung\n- Datei-Upload\n- Fortschrittsanzeige\n\n## Tipps & Best Practices\n\n1. **Webhook-URLs:**\n   - Verwenden Sie HTTPS\n   - Validieren Sie Eingaben serverseitig\n   - Implementieren Sie Rate Limiting\n\n2. **Datei-Uploads:**\n   - Informieren Sie Benutzer über Größenlimit\n   - Zeigen Sie Upload-Fortschritt an\n   - Bestätigen Sie erfolgreiche Uploads\n\n3. **Token-Sicherheit:**\n   - Tokens sind lang und zufällig\n   - Nach 7 Tagen automatisch gelöscht\n   - Nutzen Sie HTTPS für Token-Übertragung\n\n4. **Performance:**\n   - Cleanup läuft effizient\n   - Nur geänderte Tokens werden gespeichert\n   - Option wird nicht autoload\n\n## Fehlerbehebung\n\n### \"Webhook-URL ist erforderlich\"\n\n**Problem:** URL-Parameter fehlt\n\n**Lösung:**\n```\n[webhook_ajax_trigger url=\"https:\/\/example.com\/webhook\"]\n```\n\n### \"Datei darf maximal 2MB groß sein\"\n\n**Problem:** Hochgeladene Datei zu groß\n\n**Lösung:**\n1. Datei komprimieren\n2. Niedrigere Auflösung bei Bildern\n3. PDF optimieren\n\n### \"Nur PDF, JPG und PNG-Dateien sind erlaubt\"\n\n**Problem:** Falscher Dateityp\n\n**Lösung:**\n- Datei konvertieren\n- Unterstützte Formate verwenden\n\n### Cleanup funktioniert nicht\n\n**Problem:** Alte Dateien werden nicht gelöscht\n\n**Prüfung:**\n```php\n\/\/ In functions.php temporär einfügen\nadd_action('init', function() {\n  error_log('Cleanup: ' . print_r(get_option('dgptm_files'), true));\n});\n```\n\n### Modal öffnet nicht\n\n**Problem:** JavaScript nicht geladen\n\n**Lösung:**\n1. Browser-Konsole prüfen\n2. JavaScript-Fehler beheben\n3. jQuery Abhängigkeit sicherstellen",
    "features": [
        "Ajax-basierte Webhooks",
        "Studienbescheinigung Upload",
        "Token-basiertes Löschen",
        "Automatisches Cleanup (7 Tage)",
        "Datei-Validierung",
        "Modal-Formulare",
        "Mitgliedsbescheinigung anfordern",
        "Sichere Datei-Verwaltung"
    ],
    "keywords": [
        "webhook",
        "ajax",
        "upload",
        "certificate",
        "student",
        "file-management",
        "token",
        "cleanup",
        "modal"
    ],
    "module_id": "webhook-trigger",
    "last_updated": "2025-11-29 17:38:29"
}
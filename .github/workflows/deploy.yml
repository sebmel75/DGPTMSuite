name: Deploy DGPTM Plugin Suite

on:
  push:
    branches: [main]
  workflow_dispatch:  # Manueller Trigger
    inputs:
      confirm_deploy:
        description: 'Deployment bestätigen (yes/no)'
        required: true
        default: 'yes'
        type: choice
        options:
          - 'yes'
          - 'no'

# Sicherheit: Minimale Berechtigungen
permissions:
  contents: read
  actions: read

env:
  PLUGIN_NAME: dgptm-plugin-suite
  WP_PLUGIN_PATH: /wp-content/plugins/dgptm-plugin-suite

jobs:
  # Job 1: Syntax-Check und Tests
  test:
    name: PHP Syntax Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '7.4'
          tools: php-parallel-lint

      - name: PHP Syntax Check
        run: |
          echo "Checking PHP syntax..."
          find . -name "*.php" -not -path "./vendor/*" | head -100 | xargs -I {} php -l {} || true
          echo "Syntax check completed"

      - name: Check Critical Files
        run: |
          echo "Verifying critical files exist..."
          test -f dgptm-master.php && echo "✓ dgptm-master.php exists"
          test -f categories.json && echo "✓ categories.json exists"
          test -d core && echo "✓ core/ directory exists"
          test -d modules && echo "✓ modules/ directory exists"
          echo "Critical files verified"

  # Job 2: Backup und Deployment
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: test  # Nur nach erfolgreichen Tests
    environment:
      name: production
      url: https://perfusiologie.de

    # Abbrechen wenn manuell "no" gewählt wurde
    if: ${{ github.event.inputs.confirm_deploy != 'no' }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Create Deployment Package
        run: |
          echo "Creating deployment package..."
          # Exclude unnecessary files
          rsync -av --exclude='.git' \
                    --exclude='.github' \
                    --exclude='*.md' \
                    --exclude='.claude' \
                    --exclude='exports/' \
                    --exclude='*.log' \
                    --exclude='.gitignore' \
                    ./ ./deploy-package/
          echo "Package created"

      - name: Install sshpass
        run: sudo apt-get install -y sshpass

      - name: Setup SSH Known Hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Test SSH Connection
        env:
          SSHPASS: ${{ secrets.SSH_PASSWORD }}
        run: |
          echo "Testing SSH connection..."
          sshpass -e ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 \
              ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
              "echo 'SSH connection successful'" || {
            echo "❌ SSH connection failed!"
            echo "Please check:"
            echo "  - SSH_HOST: Is the IP/hostname correct?"
            echo "  - SSH_USER: Is the username correct?"
            echo "  - SSH_PASSWORD: Is the password correct?"
            echo "  - Is SSH (port 22) open on the server?"
            exit 1
          }

      - name: Create Backup on Server
        env:
          SSHPASS: ${{ secrets.SSH_PASSWORD }}
        run: |
          echo "Creating backup on server..."
          sshpass -e ssh -o StrictHostKeyChecking=no \
              ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
              "mkdir -p ~/backups && \
               cd ${{ secrets.WP_PATH }}/wp-content/plugins 2>/dev/null || mkdir -p ${{ secrets.WP_PATH }}/wp-content/plugins && cd ${{ secrets.WP_PATH }}/wp-content/plugins && \
               if [ -d '${{ env.PLUGIN_NAME }}' ]; then \
                 BACKUP_NAME='dgptm-backup-\$(date +%Y%m%d-%H%M%S).tar.gz' && \
                 tar -czf ~/backups/\$BACKUP_NAME ${{ env.PLUGIN_NAME }} && \
                 echo '✅ Backup created: '\$BACKUP_NAME; \
               else \
                 echo '⚠️ No existing plugin to backup - fresh install'; \
               fi"
        continue-on-error: true

      - name: Check Target Directory
        env:
          SSHPASS: ${{ secrets.SSH_PASSWORD }}
        run: |
          echo "=== Checking target directory ==="
          sshpass -e ssh -o StrictHostKeyChecking=no \
              ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} bash -c '
                echo "Home directory: $(pwd)"
                echo "User: $(whoami)"
                echo ""
                echo "=== Checking paths ==="

                # Test verschiedene Pfade
                for path in "/httpdocs" "httpdocs" "$HOME/httpdocs" "~/httpdocs"; do
                  if [ -d "$path" ]; then
                    echo "✓ Found: $path"
                    ls -la "$path" 2>/dev/null | head -5
                  else
                    echo "✗ Not found: $path"
                  fi
                done

                echo ""
                echo "=== Looking for wp-content ==="
                find ~ -name "wp-content" -type d 2>/dev/null | head -5 || echo "wp-content not found in home"

                echo ""
                echo "=== Creating target directory ==="
                mkdir -p ~/httpdocs/wp-content/plugins/dgptm-plugin-suite
                echo "✓ Target directory ready"
              '
        continue-on-error: true

      - name: Deploy via rsync
        env:
          SSHPASS: ${{ secrets.SSH_PASSWORD }}
        run: |
          echo "=== Deploying to production ==="

          # Versuche verschiedene Pfade
          PATHS=(
            "httpdocs/wp-content/plugins/${{ env.PLUGIN_NAME }}"
            "~/httpdocs/wp-content/plugins/${{ env.PLUGIN_NAME }}"
            "${{ secrets.WP_PATH }}/wp-content/plugins/${{ env.PLUGIN_NAME }}"
          )

          DEPLOYED=false
          for TARGET_PATH in "${PATHS[@]}"; do
            echo "Trying: ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${TARGET_PATH}/"
            if sshpass -e rsync -avz \
                  --exclude='exports/' \
                  --exclude='*.log' \
                  -e "ssh -o StrictHostKeyChecking=no" \
                  ./deploy-package/ \
                  "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${TARGET_PATH}/" 2>&1; then
              echo "✅ Deployment successful to: ${TARGET_PATH}"
              DEPLOYED=true
              break
            else
              echo "⚠️ Failed for path: ${TARGET_PATH}"
            fi
          done

          if [ "$DEPLOYED" = false ]; then
            echo "❌ All deployment attempts failed!"
            exit 1
          fi

      - name: Verify Deployment
        env:
          SSHPASS: ${{ secrets.SSH_PASSWORD }}
        run: |
          echo "Verifying deployment..."
          sshpass -e ssh -o StrictHostKeyChecking=no \
              ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
              "test -f ${{ secrets.WP_PATH }}/wp-content/plugins/${{ env.PLUGIN_NAME }}/dgptm-master.php && \
               echo '✓ Deployment verified successfully' || \
               echo '✗ Deployment verification failed'"

      - name: Clear WordPress Cache (optional)
        env:
          SSHPASS: ${{ secrets.SSH_PASSWORD }}
        run: |
          sshpass -e ssh -o StrictHostKeyChecking=no \
              ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
              "cd ${{ secrets.WP_PATH }} && \
               wp cache flush 2>/dev/null || echo 'WP-CLI not available, skipping cache flush'"
        continue-on-error: true

  # Job 3: Benachrichtigung
  notify:
    name: Deployment Notification
    runs-on: ubuntu-latest
    needs: deploy
    if: always()

    steps:
      - name: Deployment Status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "✅ Deployment to perfusiologie.de successful!"
            echo "Version: ${{ github.sha }}"
            echo "Branch: ${{ github.ref_name }}"
            echo "Time: $(date)"
          else
            echo "❌ Deployment failed!"
            echo "Check the logs for details."
          fi

{
    "title": "DGPTM - Zoho CRM & API Endpoints",
    "description": "Zoho CRM Integration mit OAuth2 Authentifizierung. Bietet Datenabruf aus Zoho CRM, benutzerdefinierte REST API Endpunkte und Webhook-Funktionalität mit SSRF-Schutz.",
    "content": "# DGPTM - Zoho CRM & API Endpoints\n\n## Übersicht\n\nDas CRM-Abruf Modul ist die zentrale Schnittstelle zur Zoho CRM Integration. Es ermöglicht den sicheren Datenabruf aus Zoho CRM über OAuth2, bietet benutzerdefinierte REST API Endpunkte und integriert sich mit anderen DGPTM-Modulen. Das Modul verfügt über umfassende Sicherheitsfunktionen inkl. SSRF-Schutz, HMAC-Signierung für interne Aufrufe und Debug-Logging.\n\n## Hauptfunktionen\n\n- OAuth2 Authentifizierung mit Zoho CRM\n- Automatische Token-Verwaltung (Access & Refresh Tokens)\n- Benutzerdefinierte REST API Endpunkte\n- SSRF-Schutz für sichere HTTP-Requests\n- Interne HMAC-Signierung für Modul-zu-Modul Kommunikation\n- Automatische Rollenverwaltung basierend auf Zoho-Daten\n- Debug-Logging für Entwicklung und Fehlerbehebung\n- EFN (European Fellow Number) Barcode-Generierung\n\n## Shortcodes\n\n### [zoho_api_data]\n\nZeigt Daten aus Zoho CRM an.\n\n**Parameter:**\n- `field`: Zoho-Feldname, der angezeigt werden soll\n- `default`: Standard-Wert, falls Feld leer ist\n\n**Beispiel:**\n```\n[zoho_api_data field=\"First_Name\" default=\"Kein Name\"]\n```\n\n### [zoho_api_data_ajax]\n\nLädt Zoho-Daten asynchron per Ajax.\n\n**Parameter:**\n- `field`: Zoho-Feldname\n- `default`: Standard-Wert\n- `loading`: Text während des Ladens\n\n**Beispiel:**\n```\n[zoho_api_data_ajax field=\"Email\" loading=\"Lädt...\"]\n```\n\n### [ifcrmfield]\n\nBedingte Anzeige basierend auf Zoho-Feldern.\n\n**Parameter:**\n- `field`: Zu prüfendes Zoho-Feld\n- `value`: Erwarteter Wert\n- `operator`: Vergleichsoperator (=, !=, >, <, contains)\n\n**Beispiel:**\n```\n[ifcrmfield field=\"aktives_mitglied\" value=\"Ja\"]\nIhr Inhalt für aktive Mitglieder\n[\/ifcrmfield]\n```\n\n### [zoho_api_antwort] \/ [dgptm_api_antwort]\n\nZeigt die vollständige API-Antwort von Zoho (für Debugging).\n\n**Beispiel:**\n```\n[zoho_api_antwort]\n```\n\n### [api-abfrage]\n\nAllgemeiner API-Aufruf an benutzerdefinierte Endpunkte.\n\n**Parameter:**\n- `slug`: Slug des registrierten Endpunkts\n- `field`: Gewünschtes Feld aus der Antwort\n\n**Beispiel:**\n```\n[api-abfrage slug=\"mein-endpunkt\" field=\"data.name\"]\n```\n\n### [api-abruf]\n\nErweiterter API-Aufruf mit mehr Optionen.\n\n**Parameter:**\n- `slug`: Endpunkt-Slug\n- `field`: Gewünschtes Feld\n- `method`: HTTP-Methode (GET, POST)\n\n**Beispiel:**\n```\n[api-abruf slug=\"statistik\" field=\"total\" method=\"GET\"]\n```\n\n### [efn_barcode]\n\nGeneriert einen Barcode für die European Fellow Number.\n\n**Parameter:**\n- `type`: Barcode-Typ (code128, qr)\n- `size`: Größe in Pixeln\n\n**Beispiel:**\n```\n[efn_barcode type=\"qr\" size=\"200\"]\n```\n\n## REST API Endpunkte\n\n### Dynamische Endpunkte\n\nDas Modul erlaubt die Registrierung beliebiger REST-Endpunkte über die Admin-Oberfläche:\n\n- Namespace: `dgptm\/v1`\n- Route: Benutzerdefiniert (z.B. `\/mein-endpunkt`)\n- Methoden: GET, POST\n- Authentifizierung: Optional (nur interne Aufrufe, öffentlich)\n\n**Beispiel-Aufruf:**\n```\nGET \/wp-json\/dgptm\/v1\/mein-endpunkt\n```\n\n## Admin-Interface\n\n### Zoho CRM Einstellungen\n\n**Menü:** Einstellungen → DGPTM Zoho\n\n**Konfiguration:**\n1. **OAuth2 Credentials:**\n   - Client ID\n   - Client Secret\n   - Redirect URI (automatisch generiert)\n\n2. **Token-Status:**\n   - Access Token Status\n   - Token-Ablaufzeit\n   - Refresh Token verfügbar\n\n3. **Debug-Einstellungen:**\n   - Debug-Logging aktivieren\/deaktivieren\n   - Log-Datei-Pfad\n\n### API Endpunkt Manager\n\n**Funktion:** Verwaltung benutzerdefinierter REST-Endpunkte\n\n**Optionen pro Endpunkt:**\n- Slug (URL-Teil)\n- Ziel-URL (wohin weitergeleitet wird)\n- HTTP-Methode\n- Nur interne Aufrufe (Toggle)\n- Beschreibung\n\n## Einrichtung\n\n### 1. Zoho CRM OAuth2 einrichten\n\n1. Bei Zoho Developer Console anmelden\n2. Neue Server-basierte Anwendung erstellen\n3. Client ID und Client Secret kopieren\n4. Redirect URI eintragen: `https:\/\/ihre-domain.de\/wp-admin\/admin.php?page=dgptm-zoho-settings&oauth_callback=1`\n5. Scopes auswählen: `ZohoCRM.modules.ALL`\n\n### 2. Plugin konfigurieren\n\n1. WordPress Admin → Einstellungen → DGPTM Zoho\n2. Client ID und Client Secret eintragen\n3. \"Mit Zoho verbinden\" klicken\n4. Bei Zoho autorisieren\n5. Zurück zu WordPress → Token-Status prüfen\n\n### 3. API-Endpunkte erstellen\n\n1. Zum API Endpunkt Manager navigieren\n2. \"Neuer Endpunkt\" klicken\n3. Slug eingeben (z.B. `mitgliedsdaten`)\n4. Ziel-URL konfigurieren\n5. Methode wählen (GET\/POST)\n6. Optional: \"Nur interne Aufrufe\" aktivieren\n7. Speichern\n\n### 4. Automatische Rollenverwaltung\n\nDas Modul synchronisiert automatisch die WordPress-Rolle \"Mitglied\" basierend auf dem Zoho-Feld `aktives_mitglied`:\n\n- **\"Ja\"** → Rolle \"Mitglied\" wird hinzugefügt\n- **\"Nein\" \/ leer** → Rolle \"Mitglied\" wird entfernt\n- Logging in Datenbanktabelle `wp_dgptm_role_changes`\n\n## Verwendung\n\n### Zoho-Daten in Seiten anzeigen\n\n```\n<h2>Willkommen [zoho_api_data field=\"First_Name\"]!<\/h2>\n<p>Ihre Mitgliedsnummer: [zoho_api_data field=\"Account_Number\"]<\/p>\n```\n\n### Bedingte Inhalte\n\n```\n[ifcrmfield field=\"aktives_mitglied\" value=\"Ja\"]\n  <div class=\"member-content\">\n    Sie haben Zugriff auf exklusive Mitgliederinhalte.\n  <\/div>\n[\/ifcrmfield]\n```\n\n### API-Endpunkte aufrufen\n\n**Von außerhalb (öffentlich):**\n```bash\ncurl https:\/\/ihre-domain.de\/wp-json\/dgptm\/v1\/mein-endpunkt\n```\n\n**Intern (aus PHP):**\n```php\n$request = new WP_REST_Request('GET', '\/dgptm\/v1\/mein-endpunkt');\n$request->set_headers(dgptm_internal_signature_headers('mein-endpunkt'));\n$response = rest_do_request($request);\n```\n\n## Technische Details\n\n### Cron-Jobs\n\n- **Token-Refresh:** Automatische Erneuerung 5 Minuten vor Ablauf\n- **Cleanup:** Alte Logs werden nach 30 Tagen gelöscht\n\n### Hooks & Filter\n\n**Actions:**\n- `dgptm_zoho_token_refreshed` - Nach Token-Erneuerung\n- `dgptm_role_changed` - Nach Rollenänderung\n- `dgptm_api_request_complete` - Nach API-Anfrage\n\n**Filter:**\n- `dgptm_allowed_hosts` - Erlaubte Hosts für SSRF-Schutz\n- `dgptm_require_dns_resolution` - DNS-Auflösung erzwingen\n- `dgptm_internal_max_drift` - Max. Zeitdifferenz für HMAC (Standard: 300s)\n- `dgptm_safe_remote_args` - HTTP-Request-Args anpassen\n\n### Datenbanktabellen\n\n**wp_dgptm_role_changes:**\n- `id` - Primärschlüssel\n- `user_id` - Benutzer-ID\n- `username` - Benutzername\n- `action` - Aktion (added\/removed)\n- `role_name` - Rollenname\n- `zoho_value` - Wert aus Zoho\n- `previous_roles` - Vorherige Rollen (JSON)\n- `new_roles` - Neue Rollen (JSON)\n- `timestamp` - Zeitstempel\n- `ip_address` - IP-Adresse\n- `user_agent` - User Agent\n\n### Sicherheit\n\n**SSRF-Schutz:**\n- Nur HTTPS-URLs erlaubt\n- Blockiert private IP-Bereiche (10.x.x.x, 192.168.x.x, 127.x.x.x)\n- Blockiert localhost und .local Domains\n- DNS-Resolution-Prüfung\n- Optional: Whitelist für erlaubte Hosts\n\n**HMAC-Signierung:**\n- Header: `x-dgptm-internal` und `x-dgptm-ts`\n- Algorithmus: SHA256\n- Zeitbasierte Validierung (max. 5 Min. Drift)\n- Verwendet WordPress wp_salt('auth')\n\n## Tipps & Best Practices\n\n1. **Token-Verwaltung:**\n   - Prüfen Sie regelmäßig den Token-Status\n   - Bei Problemen: Token manuell erneuern\n   - Refresh Token sicher aufbewahren\n\n2. **API-Endpunkte:**\n   - Verwenden Sie aussagekräftige Slugs\n   - Aktivieren Sie \"Nur interne Aufrufe\" für sensible Daten\n   - Dokumentieren Sie Ihre Endpunkte\n\n3. **Performance:**\n   - Nutzen Sie [zoho_api_data_ajax] für große Datenmengen\n   - Cachen Sie Zoho-Daten wenn möglich\n   - Aktivieren Sie Debug-Logging nur bei Bedarf\n\n4. **Sicherheit:**\n   - Verwenden Sie die Whitelist für externe URLs\n   - Prüfen Sie regelmäßig die Rollenwechsel-Logs\n   - Halten Sie Client Secret sicher\n\n## Fehlerbehebung\n\n### Token-Probleme\n\n**Symptom:** \"Token expired\" Fehler\n\n**Lösung:**\n1. Admin → DGPTM Zoho\n2. \"Token erneuern\" klicken\n3. Bei Zoho neu autorisieren\n\n### API-Fehler\n\n**Symptom:** \"Nicht erlaubte Ziel-URL\"\n\n**Lösung:**\n1. Prüfen Sie, ob URL HTTPS verwendet\n2. Überprüfen Sie Whitelist-Einstellungen\n3. Filter `dgptm_allowed_hosts` verwenden:\n```php\nadd_filter('dgptm_allowed_hosts', function($hosts) {\n    $hosts[] = 'api.example.com';\n    return $hosts;\n});\n```\n\n### Debug-Logging\n\n**Aktivierung:**\n1. Admin → DGPTM Zoho → Debug-Logging AN\n2. In wp-config.php:\n```php\ndefine('WP_DEBUG', true);\ndefine('WP_DEBUG_LOG', true);\n```\n\n**Log-Datei:** `wp-content\/debug.log`\n\n### Rollensynchronisation\n\n**Symptom:** Rolle wird nicht aktualisiert\n\n**Prüfung:**\n1. Datenbank: Tabelle `wp_dgptm_role_changes` prüfen\n2. Zoho-Feld `aktives_mitglied` kontrollieren\n3. Session neu starten (ausloggen\/einloggen)\n\n**Manuelle Synchronisation:**\n```php\n$manager = DGPTM_Role_Manager::get_instance();\n\/\/ Session-Flag zurücksetzen und erneut synchronisieren\n```",
    "features": [
        "OAuth2 Integration mit Zoho CRM",
        "Automatische Token-Verwaltung",
        "Benutzerdefinierte REST API Endpunkte",
        "SSRF-Schutz für sichere HTTP-Requests",
        "HMAC-Signierung für interne Aufrufe",
        "Automatische Rollenverwaltung",
        "Debug-Logging",
        "EFN Barcode-Generierung",
        "Shortcodes für Zoho-Daten",
        "Bedingte Content-Anzeige",
        "Rollenwechsel-Tracking"
    ],
    "keywords": [
        "zoho",
        "crm",
        "oauth2",
        "api",
        "rest",
        "webhook",
        "integration",
        "authentication",
        "barcode",
        "efn",
        "roles",
        "ssrf-protection"
    ],
    "module_id": "crm-abruf",
    "last_updated": "2025-11-29 17:38:29"
}